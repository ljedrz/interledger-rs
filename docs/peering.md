# Connecting 2 Interledger Nodes

In order for 2 nodes to connect, they must have added each other as an account with the appropriate settings set. In this document, we go over the exact settings and elaborate on the ways node operators can add accounts so that they route packets to and from them.

## Minimum Viable Peering

Assume we have Alice (node at `alice.com`) and Bob (`bob.com`), and they want to peer their nodes together. Without loss of generality, we will assume Alice initiates the peering process, and that they will use `alice` and `bob` as usernames respectively.

1. Alice issues an API token which she will use to authenticate on Bob's node.
1. Alice issues an API token which she use for Bob's node to authenticate with her.
1. Alice inserts Bob via the [ilp-cli](../crates/ilp-cli/README.md):
    ```
    ilp-cli accounts create bob \
    --auth admin-alice \
    --ilp-address "example.bob" \
    --asset-code "abc" \
    --asset-scale 9 \
    --routing-relation "Peer" \
    --ilp-over-http-url http://bob.com/accounts/alice/ilp \
    --ilp-over-http-incoming-token bob-token-on-alice \
    --ilp-over-http-outgoing-token alice-token-on-bob
    ```
1. Alice communicates her issued API tokens to Bob.
1. Bob inserts Alice to his node, in a similar manner:
    ```
    ilp-cli accounts create alice \
    --auth admin-bob \
    --ilp-address "example.alice" \
    --asset-code "abc" \
    --asset-scale 9 \
    --routing-relation "Peer" \
    --ilp-over-http-url http://alice.com/accounts/bob/ilp \
    --ilp-over-http-incoming-token alice-token-on-bob \
    --ilp-over-http-outgoing-token bob-token-on-alice
    ```
1. Done! Alice and Bob can now bilaterally route packets from each other. Essentially, when Alice sends a packet to Bob, she sends a message to the ILP-over-HTTP URL she specified when adding Bob (`http://bob.com/accounts/alice/ilp`), with the ILP-over-HTTP Outgoing Token set as an HTTP Request Authorization header. Bob's node proceeds to retrieve Alice's username from the URL, extracts the token from the HTTP Header, and proceeds to compare that with the _incoming_ token he specified when he added Alice to his node. 

If you want to peer your nodes over BTP, then you'd have to specify BTP URLs and tokens instead.

# Advanced

More advanced cases of how accounts can be addded can be found in the provided [examples](../examples). We proceed to describe some of the configuration options in more detail:

## Routing Relations

The network allows for 4 different routing relations between nodes. 
Depending on the type of relation used, the node will choose to broadcast and/or receive routes from that account over the [Connector Communication Protocol](../crates/interledger-ccp/README.md).

These are:
1. NonRoutingAccount: The node will not attempt to broadcast routes to that account, and will reject any broadcasted routes from it.
1. Peer: The node will both try to broadcast and receive routes to/from that account.
1. Child: The node will try to broadcast routes to that account, but will reject any broadcasted routes from it.
1. Parent: The node will not try to broadcast routes from that account, but will accept any broadcasted routes from it.

Assigned addresses also may depend on the network relation between nodes.
Parent nodes are expected to be in higher Interledger Address namespaces (e.g. if Alice is the parent of Bob, then it can be expected that Bob's address will be `example.alice.bob`). If no ILP Address is specified during account creation, then the account's ILP Address will be automatically generated by appending the account's username to the ILP Address of its parent account.

## URLs, Incoming and Outgoing Tokens

1. It is assumed that the node operator knows the format of ILP-over-HTTP/BTP URLs the peer is using. It is expected that there is an out of band communication channel via which the peer communicates such information.
1. The incoming token on a node MUST be the same as the outgoing token on the peer. Note that the incoming token is used either for HTTP authentication messages (HTTP Bearer token only) such as sending an SPSP payment or editing account information, or a packet coming from a peer via ILP-over-HTTP/BTP.
1. If there is no expectation of Bob sending a packet to Alice via ILP-over-HTTP, the incoming token may not be specified for the peering process.

## Actions which happen simultaneously to peering:

When adding an account, the following happens before the account is inserted to the node's store:

1. If a BTP URI is present, the node tries to establish a BTP websocket connection. The BTP outgoing token must also be set, so that the node can authorize against the peer (when the node shuts down these connections are also closed and reinitiated on launch)
1. If the added account is a `Parent`, the node MUST be a `Child` on the parent's node. This means, that the node's address must be updated based on address assigned to it by the parent. This is done as follows:
    1. The node performs an ILDCP request to the parent, in order to get its assigned ILP address (this is expected to be a lower-level address, e.g. if the parent is `g.alice`, the ILDCP Response will assign `g.alice.bob` as the node's address).
    1. The node's address gets updated to the address of the ILDCP Response. In addition, the ILP addresses all Child accounts on the node get updated to reflect the new address hierarchy (e.g. if the node previously was `example.bob` with a child account  `example.bob.dylan`, after adding `g.alice` as a parent, the child account's address would become `g.alice.bob.dylan`)
    1. The node sends a RouteControl request to the parent, which makes them start broadcasting routes to it
1. If a Settlement Engine URL is provided, then the node makes an account creation request to the engine

## Payments and Settlement-related Parameters

When adding an account, you are also able to specify a `min_balance` parameter, which expresses the minimum allowed balance an account may have so that packets are routed for it. If an account's balance reaches that value, the node will stop routing packets for that account until it is above that limit. The account's balance can be replenished by either receiving payments, or via settlement. This is what the `settle_to` and `settle_threshold` fields are for. The easiest way to understand how these work, is with an example.

Let's say Alice is peered with Bob. On Alice's node, Bob's `min_balance` is set to `-50` and his current balance is `0`. On Bob's node, Alice has the fields `settle_threshold` set to `40` and `settle_to` to `10`.

1. Bob routes a `70` unit streaming payment via Alice's node.

1. On Bob's node, this means that Alice's balance starts increasing, until it reaches `40`, and eventually `50`, which is when Alice's node stops routing since Bob has reached his credit limit. 

1. Once the `40` mark is reached, Bob's node triggers settlement, which proceeds to make a payment to Alice (via whatever method they have agreed on for settlement). The settlement amount is `30` units, which is the value required to get his money owed to Alice down to the `settle_to` value.

1. Once settlement is complete, Alice's node adjusts Bob's balance to `-10`, which is below `-50`, and proceeds to route the remaining `20` units.

1. The end result is: Bob sent `70` units over Interledger, settled for `30` units to Alice, and his balance on Alice's node is `-30` (since he routed 20 more units after settling down to 10) 

Note: Setting these parameters correctly is very important. It would not make sense for Bob to set the `settle_threshold` at `60`, since that is more (by absolute value) than the `min_balance` Alice has set for him. Had he done that, he would never hit that limit, since Alice would stop routing packets at `50`! 

`settle_to` should be set strategically below the `min_balance` limit of the peer. Setting it to `0` means that the entire debt is paid off, but a node operator who is able to settle frequently enough (e.g. via Lightning) may want to set this to a non-0 value to improve their capital efficiency.